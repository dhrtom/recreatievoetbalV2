
@{
    ViewData["Title"] = "Home Page";
}

<div class="jumbotron">
    <p>Demo</p>
    <a id="btnPush" class="btn btn-primary btn-lg" href="#" role="button"></a>

    <a id="btnSendPush" class="btn btn-danger btn-lg" href="#" role="button">Test Push Notification</a>

    <div id="subscriptionContext"> </div>
</div>








<script>
    'use strict';

    const applicationServerPublicKey  = 'BGARDFzAbeYjcJIAL-0I5dj9B19W5ge6EGrB9rTFTCYBxvYv52r5j709jLnjKHPvFFsD9AVNAYI8oMR1Fu75SBo';
    let isSubscribed = false;
    let swRegistration = null;


    function urlB64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }



    $(document).ready(function () {

        if ('serviceWorker' in navigator && 'PushManager' in window) {
            (function () {
                navigator.serviceWorker.register('sw.js?v=11').then(function (registration) {
                    //Registration was successful
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    notify("ServiceWorker registration successful");

                    swRegistration = registration;
                    initialiseUI();
                }, function (err) {
                    console.log('ServiceWorker registration failed: ', err);
                    notify("ServiceWorker registration failed");
                });

                // Subscribe to receive message from service worker

            })();
        } else {
            notify("Service Worker Not Supported!");
            console.log("Service Worker Not Supported!");
        }

     });



    function initialiseUI() {

        // Set the initial subscription value
        swRegistration.pushManager.getSubscription()
            .then(function (subscription) {
                isSubscribed = !(subscription === null);

                if (isSubscribed) {
                    console.log('User IS subscribed.');
                } else {
                    console.log('User is NOT subscribed.');
                }

                updateBtn();
            });

        $("#btnPush").click(function () {
            $("#btnPush").prop("disabled", true);

            if (isSubscribed) {
                // TODO: Unsubscribe user
            } else {
                subscribeUser();
            }

        });
    }

</script>





